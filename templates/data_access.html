<!DOCTYPE html>
<html>
<head>
    <title>Datenzugriff - Data Access</title>
    {% include 'head_includes.html' %}
</head>
<body class="glass-morphism-page">
    {% include 'menu.html' %}
    <div class="glass-container">
        <div class="main-card">
            <h1 class="mb-3 text-center"><i class="fas fa-database"></i> Datenzugriff & Export</h1>
            <div class="d-flex gap-2 justify-center flex-wrap mt-4 mb-4">
                <form method="post" action="/export_data">
                    <input type="hidden" name="username" value="{{ user_data.username }}">
                    {% if not session.get('username') == user_data.username %}
                    <input type="hidden" name="password" value="{{ password_placeholder }}">
                    {% endif %}
                    <button type="submit" name="format" value="csv" class="btn btn-success d-flex align-center gap-1">
                        <i class="fas fa-file-csv"></i>
                        <span>CSV-Datei exportieren</span>
                    </button>
                </form>
                <form method="post" action="/export_data">
                    <input type="hidden" name="username" value="{{ user_data.username }}">
                    {% if not session.get('username') == user_data.username %}
                    <input type="hidden" name="password" value="{{ password_placeholder }}">
                    {% endif %}
                    <button type="submit" name="format" value="pdf" class="btn btn-primary d-flex align-center gap-1">
                        <i class="fas fa-file-pdf"></i>
                        <span>PDF-Datei exportieren</span>
                    </button>
                </form>
                <form method="post" action="/export_data">
                    <input type="hidden" name="username" value="{{ user_data.username }}">
                    {% if not session.get('username') == user_data.username %}
                    <input type="hidden" name="password" value="{{ password_placeholder }}">
                    {% endif %}
                    <button type="submit" name="format" value="json" class="btn btn-warning d-flex align-center gap-1">
                        <i class="fas fa-file-code"></i>
                        <span>JSON-Datei exportieren</span>
                    </button>
                </form>
            </div>
            <div class="glass-card section mt-4">
                <h2 class="mb-2">Datenlöschung</h2>
                <p class="text-danger mb-2">Hinweis: Die Datenlöschung ist endgültig und kann nicht rückgängig gemacht werden.</p>
                <form method="post" action="/request_data_deletion">
                    <div class="mb-2">
                        <label for="deletion-username" class="mb-1 text-left">Benutzername:</label>
                        <input type="text" id="deletion-username" name="username" required class="input">
                    </div>
                    <div class="mb-2">
                        <label for="deletion-password" class="mb-1 text-left">Passwort:</label>
                        <input type="password" id="deletion-password" name="password" required class="input">
                    </div>
                    <div class="mb-2">
                        <label for="deletion-reason" class="mb-1 text-left">Grund für die Löschung (optional):</label>
                        <textarea id="deletion-reason" name="reason" rows="3" class="input"></textarea>
                    </div>
                    <div class="mb-2 d-flex align-center gap-1">
                        <input type="checkbox" name="confirm_deletion" required class="mr-1">
                        <label for="confirm_deletion" class="mb-0">Ich bestätige die endgültige Löschung meiner Daten.</label>
                    </div>
                    <button type="submit" class="btn btn-danger mt-2">Datenlöschung beantragen</button>
                </form>
            </div>
            <div class="mt-4 text-center">
                <a href="/privacy_policy" class="btn btn-secondary">Datenschutzerklärung ansehen</a>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Benutzer-Daten bearbeiten
            const editUserBtn = document.getElementById('edit-user-data-btn');
            const editUserForm = document.getElementById('edit-user-form');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            
            if (editUserBtn && editUserForm && cancelEditBtn) {
                editUserBtn.addEventListener('click', function() {
                    editUserForm.style.display = 'block';
                    editUserBtn.style.display = 'none';
                });
                
                cancelEditBtn.addEventListener('click', function() {
                    editUserForm.style.display = 'none';
                    editUserBtn.style.display = 'inline-block';
                });
            }
            
            // Anwesenheitsaufzeichnungen bearbeiten
            const editRecordBtns = document.querySelectorAll('.edit-record-btn');
            const editRecordModal = document.getElementById('edit-record-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const cancelModalBtns = document.querySelectorAll('.cancel-modal-btn');
            
            if (editRecordBtns.length && editRecordModal && closeModalBtn) {
                editRecordBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const recordId = this.dataset.recordId;
                        const date = this.dataset.date;
                        const checkin = this.dataset.checkin;
                        const checkout = this.dataset.checkout;
                        
                        // Datum aufteilen für Input-Feld
                        const dateParts = date.split('.');
                        const formattedDate = dateParts.length === 3 ? 
                            `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}` : // dd.mm.yyyy -> yyyy-mm-dd
                            date;
                            
                        document.getElementById('edit-record-id').value = recordId;
                        document.getElementById('edit-record-date').value = formattedDate;
                        document.getElementById('edit-record-checkin').value = checkin;
                        document.getElementById('edit-record-checkout').value = checkout;
                        
                        editRecordModal.style.display = 'block';
                    });
                });
                
                closeModalBtn.addEventListener('click', function() {
                    editRecordModal.style.display = 'none';
                });
                
                cancelModalBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        editRecordModal.style.display = 'none';
                    });
                });
                
                // Schließt das Modal, wenn außerhalb geklickt wird
                window.addEventListener('click', function(event) {
                    if (event.target === editRecordModal) {
                        editRecordModal.style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>
</html>